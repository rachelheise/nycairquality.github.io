<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Process</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Home</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="https://asingh100.shinyapps.io/dashboard/">
    <span class="fa fa-chart-line"></span>
     
    Dashboard
  </a>
</li>
<li>
  <a href="report.html">
    <span class="fa fa-file-text-o fa-lg"></span>
     
    Report
  </a>
</li>
<li>
  <a href="process.html">
    <span class="fas fa fas fa-cog"></span>
     
    Process
  </a>
</li>
<li>
  <a href="screencast.html">
    <span class="fa fa-video"></span>
     
    Screencast
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/rachelheise/nycairquality.github.io.git">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Process</h1>

</div>


<style type="text/css">

h1.title {
  text-align: center;
}

</style>
<center>
<p><strong>Description of Page:</strong></p>
<p>This page of our website will give you an overview of the process we went through to conduct this analysis. It will show how we explored and cleaned the major data sets that we used to better understand the data as well as the iteration of processes that we used to come up with our final product.</p>
<p><strong>Exploratory Analysis for AQI in 2019 and 2020:</strong></p>
<p>For the AQI variable we obtained the data from the Air Quality Open Data Platform and filtered the data to only include information about New York City. We then looked online and found out that the EPA actually reports the Air Quality of a specific place by using the Air Quality Index which is calculated by using a piecewise linear function for each pollutant and then taking the maximum value of each pollutant’s AQI value to calculate the overall AQI value. The code we implemented to do this is shown below. Note that we did not include the code for 2019 on this page since the procedure is exactly the same as for 2020, if you would like to see the code for 2019 please reference the process.Rmd document on this repository.</p>
<pre class="r"><code># Data import and cleaning
library(tidyverse)
library(data.table)

AQI_2020 = fread(&quot;./data/waqi-covid19-airqualitydata-2020.csv&quot;) %&gt;%
  janitor::clean_names() %&gt;% 
  filter(country == &quot;US&quot;) %&gt;%
  filter(city == &quot;Brooklyn&quot; | city == &quot;Queens&quot; | city == &quot;The Bronx&quot; | city == &quot;Staten Island&quot; | city == &quot;Manhattan&quot;) %&gt;%
  mutate(borough = city) %&gt;%
  select(-c(city, country)) %&gt;%
  pivot_wider(names_from = &quot;specie&quot;, values_from = c(&quot;count&quot;, &quot;min&quot;, &quot;max&quot;, &quot;median&quot;, &quot;variance&quot;)) %&gt;% 
  select(date, borough, median_pm25, median_o3, median_co, median_no2)

# Write functions that calculate the individual AQI (IAQI) for each individual pollutant

IAQI_formula_o3 = function(AQI){
  if (is.na(AQI) == TRUE) { # Accounting for missing values
    AQI_o3 = 0
  }
  
  else if (AQI &lt;= 54 &amp;&amp; AQI &gt;= 0 ) {
    IAQI_o3 = (50/54)*(AQI - 0) + 0
  }
  
  else if (AQI &lt;= 70 &amp;&amp; AQI &gt; 54 ) {
    IAQI_o3 = (50/22)*(AQI - 55) + 51
  }
  
  else if (AQI &lt;= 85 &amp;&amp; AQI &gt; 70) {
    IAQI_o3 = (50/14)*(AQI - 70) + 101
  }
  
  else if (AQI &lt;= 105 &amp;&amp; AQI &gt; 85 ) {
    IAQI_o3 = (50/19)*(AQI - 86) + 151
  }
  
  else if (AQI &lt;= 200 &amp;&amp; AQI &gt; 105 ) {
    IAQI_o3 = (99/94)*(AQI - 106) + 201
  }
  
  else if (AQI &lt;= 404 &amp;&amp; AQI &gt; 204) {
    IAQI_o3 = (99/199)*(AQI - 205) + 201
  }
  
  else{
    IAQI_o3 = (199/199)*(AQI - 405) + 301
  }
}

IAQI_formula_pm25 = function(AQI){
  if (is.na(AQI) == TRUE) { # Accounting for missing values
    IAQI_pm25 = 0
  }
  
  else if (AQI &lt;= 12 &amp;&amp; AQI &gt;= 0 ) {
    IAQI_pm25 = (50/12)*(AQI - 0) + 0
  }
  
  else if (AQI &lt;= 35.4 &amp;&amp; AQI &gt;= 12.1 ) {
    IAQI_pm25 = (50/23.3)*(AQI - 12.1) + 51
  }
  
  else if (AQI &lt;= 55.4 &amp;&amp; AQI &gt;= 35.5 ) {
    IAQI_pm25 = (50/19.9)*(AQI - 35.5) + 101
  }
  
  else if (AQI &lt;= 150.4 &amp;&amp; AQI &gt;= 55.5 ) {
    IAQI_pm25 = (50/94.9)*(AQI - 55.5) + 151
  }
  
  else{
    IAQI_pm25 = (99/99.9)*(AQI - 150.5) + 201
  }
}

IAQI_formula_co = function(AQI){
  if (is.na(AQI) == TRUE) { # Accounting for missing values
    IAQI_co = 0
  }
  
  else if (AQI &lt;= 4.4 &amp;&amp; AQI &gt;= 0) {
    IAQI_co = (50/4.4)*(AQI - 0) + 0
  }
  
  else if (AQI &lt;= 9.4 &amp;&amp; AQI &gt;= 4.5 ) {
    IAQI_co = (50/4.9)*(AQI - 4.5) + 51
  }
  
  else{
    IAQI_co = (199/19.9)*(AQI - 30.5) + 301
  }
}

IAQI_formula_no2 = function(AQI){
  if (is.na(AQI) == TRUE) { # Accounting for missing values
    IAQI_no2 = 0
  }
  
  else if (AQI &lt;= 53 &amp;&amp; AQI &gt;= 0 ) {
    IAQI_no2 = (50/53)*(AQI - 0) + 0
  }
  
  else if (AQI &lt;= 100 &amp;&amp; AQI &gt;= 54 ) {
    IAQI_no2 = (50/46)*(AQI - 54) + 51
  }
  
  else{
    IAQI_no2 = (50/259)*(AQI - 101) + 101
  }
}

# Generate IAQIs, determine AQI and AQI category based on max IAQI per day

AQI_2020 =
  AQI_2020 %&gt;% 
  mutate(
    IAQI_o3 = map(median_o3, IAQI_formula_o3),
    IAQI_pm25 = map(median_pm25, IAQI_formula_pm25),
    IAQI_co = map(median_co, IAQI_formula_co),
    IAQI_no2 = map(median_no2, IAQI_formula_no2)
    ) %&gt;% 
  rowwise() %&gt;% 
  mutate(
    AQI = max(IAQI_o3, IAQI_pm25, IAQI_co, IAQI_no2, na.rm = TRUE), # Taking max of the individual AQI scores
    AQI_category =
      if_else(
        AQI &lt;= 50 &amp; AQI &gt;= 0,
        &quot;Good&quot;,
        if_else(
          AQI &lt;= 100 &amp; AQI &gt; 50,
          &quot;Moderate&quot;,
          if_else(
            AQI &lt;= 150 &amp; AQI &gt; 100,
            &quot;Unhealthy for Sensitive Populations&quot;,
            &quot;Unhealthy&quot;)
        )
      )
  )</code></pre>
<p>After computing the AQI’s for the 2019 and 2020 data we then merged the two data sets to try to compare the two years to see if there was any significant changes in Air Quality between 2019 (when COVID had not hit yet) versus in 2020 (during the time of COVID).</p>
<pre class="r"><code>AQI_2019_and_2020 =
  rbind(AQI_2019, AQI_2020) %&gt;% 
  as_tibble() %&gt;% 
  mutate(
    date = as.Date(date, tryFormats = c(&quot;%Y-%m-%d&quot;)),
    borough = recode(borough, &quot;The Bronx&quot; = &quot;Bronx&quot;),
    IAQI_o3 = unlist(IAQI_o3),
    IAQI_pm25 = unlist(IAQI_pm25),
    IAQI_co = unlist(IAQI_co),
    IAQI_no2 = unlist(IAQI_no2)
  )</code></pre>
<p><strong>Exploratory Analysis and Data Cleaning for COVID Data Set:</strong></p>
<p>We then examined the COVID cases data set and cleaned the data to make the data more readable. This included changing the format of the date variable as well as pivoting the data longer so we can see COVID case trends per borough. We also added in a variable that indicates dates in which NY Government COVID policies were enacted. The code we used to do this is shown below.</p>
<pre class="r"><code>nyc_daily_borough_testing =
  read_csv(
      &quot;./data/covid_data/nyc_daily_covid.csv&quot;) %&gt;% 
  janitor::clean_names() %&gt;% 
  rename(date = date_of_interest) %&gt;% 
  mutate(
    date = as.Date(date, format = &quot;%m/%d/%Y&quot;),
    date = as.Date(date, tryFormats = c(&quot;%Y-%m-%d&quot;))
  ) %&gt;%
  pivot_longer(
    bx_case_count:si_death_count_7day_avg,
    names_to = &quot;borough_variable&quot;,
    values_to = &quot;observed_value&quot;
  ) %&gt;% 
  mutate(
    borough_variable = str_replace(borough_variable, &quot;bx_&quot;, &quot;Bronx/&quot;),
    borough_variable = str_replace(borough_variable, &quot;bk_&quot;, &quot;Brooklyn/&quot;),
    borough_variable = str_replace(borough_variable, &quot;qn_&quot;, &quot;Queens/&quot;),
    borough_variable = str_replace(borough_variable, &quot;si_&quot;, &quot;Staten Island/&quot;),
    borough_variable = str_replace(borough_variable, &quot;mn_&quot;, &quot;Manhattan/&quot;)
  ) %&gt;% 
  separate(borough_variable, into = c(&quot;borough&quot;, &quot;observation_type&quot;), sep = &quot;/&quot;) %&gt;% 
  arrange(date, borough, observation_type, observed_value) %&gt;% 
  pivot_longer(
    case_count:incomplete,
    names_to = &quot;total_observation_type&quot;,
    values_to = &quot;total_observed_value&quot;
  ) %&gt;% 
  filter(observation_type == c(&quot;case_count&quot;, &quot;case_count_7day_avg&quot;))

# Add proof-of-concept covid policy changes to df
# Maybe consider deleting this later
nyc_daily_borough_testing = 
  nyc_daily_borough_testing %&gt;% 
  mutate(
    policy_change = case_when(
      date == &quot;2020-03-07&quot; ~ &quot;State of Emergency&quot;,
      date == &quot;2020-03-22&quot; ~ &quot;PAUSE Order&quot;,
      date == &quot;2020-08-08&quot; ~ &quot;Phase 1 Opening&quot;,
      date == &quot;2020-10-01&quot; ~ &quot;Primary Schools Open&quot;),
    dates_vline = date,
    dates_vline = case_when(
      date == &quot;2020-03-07&quot; ~ &quot;TRUE&quot;,
      date == &quot;2020-03-22&quot; ~ &quot;TRUE&quot;,
      date == &quot;2020-08-08&quot; ~ &quot;TRUE&quot;,
      date == &quot;2020-10-01&quot; ~ &quot;TRUE&quot;)
  )</code></pre>
<p><strong>Exploratory Plots for COVID Case Data and AQI Data:</strong></p>
<pre class="r"><code>nyc_daily_borough_testing %&gt;% 
  filter(observation_type == c(&quot;case_count&quot;)) %&gt;% 
  filter(total_observation_type == c(&quot;case_count&quot;)) %&gt;% 
  group_by(date, borough, observation_type) %&gt;% 
  ggplot(aes(x = date)) + 
  geom_line(aes(x = date, y = observed_value, color = borough, alpha = 0.5)) +
  geom_line(aes(x = date, y = total_observed_value, alpha = 0.5,  group = total_observation_type)) +
  geom_smooth(
    aes(x = date, y = observed_value, color = borough), 
        alpha = 0.8, se = F,
    method = &quot;gam&quot;) +
  geom_smooth(
    aes(x = date, y = total_observed_value), 
        alpha = 0.8, se = F) +
  scale_x_date(date_breaks = &quot;1 month&quot;, date_labels = &quot;%b %d&quot;, limits = as.Date(c(&quot;2020-03-01&quot;, &quot;2020-12-01&quot;))) +
  coord_cartesian(ylim = c(0, 6000)) +
  labs(
    title = &quot;Case Count per NYC Borough over Time&quot;,
    x = &quot;Week Number&quot;,
    y = &quot;Value&quot;,
    caption = &quot;P8105 Final Project&quot;)</code></pre>
<pre><code>## Warning: Removed 5 rows containing non-finite values (stat_smooth).

## Warning: Removed 5 rows containing non-finite values (stat_smooth).</code></pre>
<pre><code>## Warning: Removed 5 row(s) containing missing values (geom_path).

## Warning: Removed 5 row(s) containing missing values (geom_path).</code></pre>
<p><img src="process_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<p>For this plot we wanted to explore how cases changed over time for each borough of New York City. Things we were looking for were any outliers in the data, which borough had the highest number of cases, and when did cases start to increase/decrease. We then compared our preliminary findings from this plot to other plots/data to assess why cases may have gone up or down at certain points in time.</p>
<pre class="r"><code>nyc_daily_borough_testing %&gt;% 
  filter(observation_type == c(&quot;case_count_7day_avg&quot;)) %&gt;% 
  group_by(date, borough, observation_type) %&gt;% 
  ggplot(aes(x = date, y = observed_value, color = borough)) + 
  geom_line() +
  geom_vline(xintercept = as.numeric(
    as.Date(
      c(&quot;2020-03-07&quot;,&quot;2020-03-22&quot;, &quot;2020-08-08&quot;, &quot;2020-10-01&quot;))),  
    linetype = 2) +
  geom_text(
    aes(x = as.Date(&quot;2020-03-07&quot;),
                label = c(&quot;State of Emergency Declared&quot;), 
        y = 1000), 
    alpha = 0.5, colour = &quot;red&quot;, angle = 90, vjust = -1, text = element_text(size = 6)) +
  scale_x_date(date_breaks = &quot;1 month&quot;, date_labels = &quot;%b %d&quot;, limits = as.Date(c(&quot;2020-03-01&quot;, &quot;2020-12-01&quot;))) +
  coord_cartesian(ylim = c(0,2000)) +
  labs(
    title = &quot;7 Day Case Count Average per NYC Borough over Time&quot;,
    x = &quot;Week Number&quot;,
    y = &quot;Value&quot;,
    caption = &quot;P8105 Final Project&quot;)</code></pre>
<pre><code>## Warning: Ignoring unknown parameters: text</code></pre>
<pre><code>## Warning: Removed 20 row(s) containing missing values (geom_path).</code></pre>
<p><img src="process_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>In this plot we were testing to see if we could add vertical lines corresponding to the date that certain government mandates were enacted. We created this plot to assess if government mandates had an effect on the case count over time.</p>
<pre class="r"><code>AQI_2020 %&gt;% 
  ggplot(aes(x = date, y = median_co, color = borough)) + 
    geom_point(alpha = .2) +
    geom_line(alpha = .75, size = .75) +
      scale_x_date(date_breaks = &quot;1 month&quot;, date_labels = &quot;%b %y&quot;) +
  labs(
    title = &quot;Median CO Emmissions over Time for each NYC borough, 2020&quot;,
    x = &quot;Month&quot;,
    y = &quot;Median CO (Parts per Million)&quot;,
    caption = &quot;Examining COVID-19 Incidence, P8105 Final Project&quot;) </code></pre>
<pre><code>## Warning: Removed 92 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 4 row(s) containing missing values (geom_path).</code></pre>
<p><img src="process_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<pre class="r"><code>AQI_2020 %&gt;% 
  ggplot(aes(x = date, y = median_pm25, color = borough)) + 
    geom_point(alpha = .2) +
    geom_line(alpha = .75, size = .75) +
      scale_x_date(date_breaks = &quot;1 month&quot;, date_labels = &quot;%b %y&quot;) +
  labs(
    title = &quot;Median Particulate Matter (size&lt;2.5 um) Levels over Time for each borough, 2020&quot;,
    x = &quot;Month&quot;,
    y = &quot;Median Particulate Matter (&lt; 2.5 um) Levels (Parts per Millon)&quot;,
    caption = &quot;Examining COVID-19 Incidence, P8105 Final Project&quot;) </code></pre>
<p><img src="process_files/figure-html/unnamed-chunk-3-2.png" width="672" /></p>
<pre class="r"><code>AQI_2020 %&gt;% 
  group_by(borough) %&gt;% 
  ggplot(aes(x = date, y = AQI)) +
  geom_line() +
  geom_smooth()</code></pre>
<p><img src="process_files/figure-html/unnamed-chunk-3-3.png" width="672" /></p>
<p>These plots are some of the preliminary plots we made to explore and assess some of the trends in the AQI data. We first made a plot assessing the median CO levels (ppm), an important indicator of air quality, over time for each borough to see if there were any distinct trends in CO levels over time. The second plot we made was for the median particulate matter levels over time for each borough to see if there were any trends in the amount of particulate matter in the air. The last plot we made was an attempt to do GAM smoothing on the AQI data which was something that we did not find necessary in our final analysis as we instead took the 7 day rolling average of AQI for each borough and used this value in our plot, which helped smooth out the AQI lines and uncover more trends that we missed with just the AQI per day variable.</p>
<p><strong>Joining the AQI and COVID Data:</strong></p>
<p>After conducting some exploratory analysis through the use of these charts and cleaning the datasets, we wanted to merge the AQI and COVID data to get a sense of how COVID cases affected the AQI for each borough over time. We thus did a left join of the COVID data to the AQI data by date and borough to accomplish this.</p>
<pre class="r"><code>AQI_covid_master =
  left_join(nyc_daily_borough_testing, AQI_2019_and_2020, by = c(&quot;date&quot;, &quot;borough&quot;))</code></pre>
<p>As stated before since we realized that GAM smoothing may not be the best option for us when plotting AQI, we calculated the 7 day rolling average of the AQI which helped to smooth out our AQI line. This was done for the overall AQI as well as the Carbon Monoxide AQI as we use both in our final analysis to come to a clear conclusion about the affect of Coronavirus on Air Quality.</p>
<pre class="r"><code>total_AQI = AQI_covid_master %&gt;% 
  select(date, borough, AQI) %&gt;% 
  distinct(date, borough, .keep_all = TRUE) %&gt;% 
  group_by(date) %&gt;% 
  mutate(avg_AQI = mean(AQI)) %&gt;% 
  ungroup() %&gt;% 
  select(date, avg_AQI) %&gt;% 
  distinct(date, .keep_all = TRUE) %&gt;% 
  arrange(date) %&gt;% 
  mutate(AQI_7day_avg = zoo::rollmean(avg_AQI, k = 7, fill = NA))</code></pre>
<pre class="r"><code>AQI_by_borough = AQI_covid_master %&gt;% 
  select(date, borough, IAQI_co) %&gt;% 
  distinct(date, borough, .keep_all = TRUE) %&gt;% 
  group_by(borough) %&gt;% 
  arrange(date) %&gt;% 
  mutate(co_borough_7day_avg = zoo::rollmean(IAQI_co, k = 7, fill = NA)) %&gt;% 
  ungroup() %&gt;% 
  select(-IAQI_co)</code></pre>
<p>We then merged these two rolling averages into our final data frame by using a left join.</p>
<pre class="r"><code>AQI_covid_master = AQI_covid_master %&gt;% 
  left_join(total_AQI, by = &quot;date&quot;) %&gt;% 
  left_join(AQI_by_borough, by = c(&quot;date&quot;, &quot;borough&quot;))</code></pre>
<p><strong>Dashboard Selection:</strong></p>
<p>For our dashboard we initially were thinking of doing a plotly flexdashboard until we came up with the idea to add user interactivity for our AQI map. Then after searching on the internet we found out how to create a shiny dashboard which allows the user to change our AQI map to see the AQI values by borough on a specific date. This increases the interpretability and functionality of our AQI map plot as it allows the user to make conclusions about the AQI for whatever date they choose which they would not be able to do on a static plotly map. We initially just included the AQI value and the borough name for our labels on the AQI map plot but after consulting with Gavin we realized that we should add more data such as the AQI for CO.</p>
<p><strong>Shiny Leaflet for Dashboard:</strong></p>
<p>The code below shows the process that we used to create this interactive map for AQI per borough as described in the previous section. We used set coordinates (longitude and latitude values) that represented each borough and created a data frame of all of these values. These coordinates would then be used to create a point on the map to show the AQI for that particular borough. Then we selected colors for these points on the map based on the category the overall AQI was for that day. Due to wanting user interactivity we felt that it was best to use a shiny leaflet plot as we could add a date input sidebar that would allow the user to see AQI values per borough on the map for a specific day.</p>
<pre class="r"><code>borough_coord = tibble(&quot;borough&quot; = c(&quot;Bronx&quot;, &quot;Manhattan&quot;, &quot;Brooklyn&quot;, &quot;Queens&quot;, &quot;Staten Island&quot;), &quot;latitude&quot; = c(40.8448, 40.7731, 40.6782, 40.7282, 40.5795), &quot;longitude&quot; = c(-73.8648, -73.9712, -73.9442, -73.7949, -74.1502))
color_df = colorFactor(c(&quot;green&quot;, &quot;yellow&quot;, &quot;orange&quot;, &quot;red&quot;), domain = c(&quot;Good&quot;, &quot;Moderate&quot;, &quot;Unhealthy for Sensitive Populations&quot;, &quot;Unhealthy&quot;))
AQI_covid_master = AQI_covid_master %&gt;% 
  left_join(borough_coord, by = &quot;borough&quot;)
output$map = renderLeaflet({
  AQI_covid_master %&gt;% 
    filter(date == input[[&quot;date&quot;]]) %&gt;% 
    mutate(popup = str_c(&quot;&lt;strong&gt;&quot;, borough, &quot;&lt;/strong&gt;&quot;, &quot;&lt;br/&gt;&quot;, &quot;Date: &quot;, date, &quot;&lt;br/&gt;&quot;, &quot;Air Quality Category: &quot;, AQI_category, &quot;&lt;br/&gt;&quot;, &quot;Air Quality Index: &quot;, round(AQI, 2), &quot;&lt;br/&gt;&quot;, &quot;Carbon Monoxide Level: &quot;, lapply(IAQI_co, round, 2)) %&gt;% 
    map(htmltools::HTML)) %&gt;%
    leaflet() %&gt;%
    addTiles() %&gt;%
    setView(-73.95, 40.7228, zoom = 11) %&gt;%
    addProviderTiles(&quot;CartoDB.Positron&quot;) %&gt;% 
    addCircleMarkers(
      radius = 20,
      lng = ~longitude,
      lat = ~latitude,
      stroke = FALSE,
      fillOpacity = 0.8, 
      color = ~color_df(AQI_category),
      label = ~popup
    ) %&gt;% 
    addLegend(&quot;bottomright&quot;, colors = c(&quot;green&quot;, &quot;yellow&quot;, &quot;orange&quot;, &quot;red&quot;),
              labels = c(&quot;Good&quot;, &quot;Moderate&quot;, &quot;Unhealthy for Sensitive Populations&quot;, &quot;Unhealthy&quot;),
              title = &quot;Air Quality Index&quot;)
})
leafletOutput(&#39;map&#39;, height=1000)</code></pre>
<pre class="r"><code>  dateInput(
      &quot;date&quot;,
      label = h3(&quot;Date:&quot;),
      value = &quot;2020-02-29&quot;, # Default value
      min = &quot;2020-02-29&quot;, # Min value
      max = &quot;2020-11-14&quot;) # Max value</code></pre>
<p><strong>Other Plots:</strong></p>
<p>For the other plots on our final dashboard we used plotly as we didn’t need to have user input since they were showing the trend of different variables over time anyways. However we still wanted to add some features to increase the clarity of our plots such as showing labels when a user hovers over a specific data point in the plot. Thus, we used plotly instead of just a ggplot as plotly would allow us to incorporate this feature into our line plots. The code we used to create these line plots is shown below.</p>
<div id="aqi-and-covid-cases-per-borough" class="section level3">
<h3>AQI and COVID Cases Per Borough</h3>
<pre class="r"><code>renderPlotly({
  AQI_covid_master %&gt;% 
  mutate(
    text_label_1 = str_c(&quot;Date: &quot;, date, &quot;\nAQI Index Value: &quot;, AQI_7day_avg),
    text_label_2 = str_c(&quot;Date: &quot;, date, &quot;\nCOVID Case Count: &quot;, total_observed_value)
    ) %&gt;% 
  filter(observation_type == c(&quot;case_count&quot;)) %&gt;% 
  filter(total_observation_type == c(&quot;case_count&quot;)) %&gt;% 
  plot_ly(
      x = ~date,
      y = ~AQI_7day_avg,
      name = &quot;AQI Index (7 Day Rolling Avg.)&quot;,
      type = &quot;scatter&quot;,
      mode = &quot;lines&quot;,
      opacity = 0.3,
      text = ~text_label_1,
      line = list(color = &quot;#FFA500&quot;)
      ) %&gt;%
    add_trace(
      x = ~date,
      y = ~total_observed_value,
      type = &quot;scatter&quot;,
      mode = &quot;lines&quot;,
      name = &quot;COVID Case Count&quot;,
      line = list(color = &quot;#005EFF&quot;),
      opacity = 0.8,
      text = ~text_label_2,
      yaxis = &quot;y2&quot;,
      inherit = FALSE) %&gt;%  #covid data
    layout(
      xaxis = list(title = &quot;Date&quot;),
      yaxis = list(side = &quot;left&quot;, title = &quot;AQI Index (7 day avg)&quot;, showgrid = FALSE, zeroline = FALSE),
      yaxis2 = list(side = &quot;right&quot;, overlaying = &quot;y&quot;, title = &quot;Case Count&quot;, showgrid = FALSE, zeroline = FALSE)
     )
})</code></pre>
</div>
<div id="carbon-monoxide-co-iaqi-by-borough-and-nyc-covid-case-count-over-time" class="section level3">
<h3>Carbon Monoxide (CO) IAQI by Borough and NYC COVID Case Count Over Time</h3>
<pre class="r"><code>renderPlotly({
  AQI_covid_master %&gt;%
    mutate(
    text_label_3 = str_c(&quot;Date: &quot;, date, &quot;\nBorough: &quot;, borough, &quot;\nAQI Index Value: &quot;, co_borough_7day_avg),
    text_label_4 = str_c(&quot;Date: &quot;, date, &quot;\nCOVID Case Count: &quot;, total_observed_value)
    ) %&gt;% 
    mutate(borough_titles = str_c(&quot;Carbon Monoxide IAQI &quot;, borough)) %&gt;% 
    filter(total_observation_type == &quot;case_count&quot;) %&gt;% 
    plot_ly(
    x = ~date,
    y = ~co_borough_7day_avg,
    split = ~borough_titles,
    type = &quot;scatter&quot;,
    mode = &quot;lines&quot;,
    opacity = 0.3,
    text = ~text_label_3,
    color = ~borough_titles,
    colors = &quot;Oranges&quot;
    ) %&gt;% 
    add_trace(
      x = ~date,
      y = ~total_observed_value,
      type = &quot;scatter&quot;,
      mode = &quot;lines&quot;,
      line = list(color = &quot;#005EFF&quot;),
      opacity = 0.8,
      text = ~text_label_4,
      yaxis = &quot;y2&quot;,
      inherit = FALSE,
      name = &quot;NYC COVID Case Count&quot;
      ) %&gt;%
    layout(
      legend = list(x = &quot;Jul 1, 2020&quot;, y = 120),
      xaxis = list(title = &quot;Date&quot;),
      yaxis = list(side = &quot;left&quot;, title = &quot;CO IAQI (7 day avg.)&quot;, showgrid = FALSE, zeroline = FALSE),
      yaxis2 = list(side = &quot;right&quot;, overlaying = &quot;y&quot;, title = &quot;Case Count&quot;, showgrid = FALSE, zeroline = FALSE)
      )
  })</code></pre>
</div>

<html>
  
&nbsp;
<hr />

<small>
  
<p style="text-align: center;">
  Rachel Heise, Fiona Ehrich, Emil Hafeez, Anmol Singh
</p>

</small>

</html>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
