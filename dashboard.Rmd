---
title: "NYC Air Quality Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source: embed
runtime: shiny
---

```{r setup, include = FALSE}
library(flexdashboard)
library(leaflet)
library(tidyverse)
library(httr)
library(data.table)
library(shiny)
library(plotly)
library(mgcv)



theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

```{r 2020 air quality data cleaning, include = FALSE}
# Data import and cleaning

AQI_2020 = fread("./data/waqi-covid19-airqualitydata-2020.csv") %>%
  janitor::clean_names() %>% 
  filter(country == "US") %>%
  filter(city == "Brooklyn" | city == "Queens" | city == "The Bronx" | city == "Staten Island" | city == "Manhattan") %>%
  mutate(borough = city) %>%
  select(-c(city, country)) %>%
  pivot_wider(names_from = "specie", values_from = c("count", "min", "max", "median", "variance")) %>% 
  select(date, borough, median_pm25, median_o3, median_co, median_no2)

# Write functions that calculate the individual AQI (IAQI) for each individual pollutant

IAQI_formula_o3 = function(AQI){
  if (is.na(AQI) == TRUE) { # Accounting for missing values
    AQI_o3 = 0
  }
  
  else if (AQI <= 54 && AQI >= 0 ) {
    IAQI_o3 = (50/54)*(AQI - 0) + 0
  }
  
  else if (AQI <= 70 && AQI > 54 ) {
    IAQI_o3 = (50/22)*(AQI - 55) + 51
  }
  
  else if (AQI <= 85 && AQI > 70) {
    IAQI_o3 = (50/14)*(AQI - 70) + 101
  }
  
  else if (AQI <= 105 && AQI > 85 ) {
    IAQI_o3 = (50/19)*(AQI - 86) + 151
  }
  
  else if (AQI <= 200 && AQI > 105 ) {
    IAQI_o3 = (99/94)*(AQI - 106) + 201
  }
  
  else if (AQI <= 404 && AQI > 204) {
    IAQI_o3 = (99/199)*(AQI - 205) + 201
  }
  
  else{
    IAQI_o3 = (199/199)*(AQI - 405) + 301
  }
}

IAQI_formula_pm25 = function(AQI){
  if (is.na(AQI) == TRUE) { # Accounting for missing values
    IAQI_o3 = 0
  }
  
  else if (AQI <= 12 && AQI >= 0 ) {
    IAQI_pm25 = (50/12)*(AQI - 0) + 0
  }
  
  else if (AQI <= 35.4 && AQI >= 12.1 ) {
    IAQI_pm25 = (50/23.3)*(AQI - 12.1) + 51
  }
  
  else if (AQI <= 55.4 && AQI >= 35.5 ) {
    IAQI_pm25 = (50/19.9)*(AQI - 35.5) + 101
  }
  
  else if (AQI <= 150.4 && AQI >= 55.5 ) {
    IAQI_pm25 = (50/94.9)*(AQI - 55.5) + 151
  }
  
  else{
    IAQI_pm25 = (99/99.9)*(AQI - 150.5) + 201
  }
}

IAQI_formula_co = function(AQI){
  if (is.na(AQI) == TRUE) { # Accounting for missing values
    IAQI_o3 = 0
  }
  
  else if (AQI <= 4.4 && AQI >= 0) {
    IAQI_co = (50/4.4)*(AQI - 0) + 0
  }
  
  else if (AQI <= 9.4 && AQI >= 4.5 ) {
    IAQI_co = (50/4.9)*(AQI - 4.5) + 51
  }
  
  else{
    IAQI_co = (199/19.9)*(AQI - 30.5) + 301
  }
}

IAQI_formula_no2 = function(AQI){
  if (is.na(AQI) == TRUE) { # Accounting for missing values
    IAQI_o3 = 0
  }
  
  else if (AQI <= 53 && AQI >= 0 ) {
    IAQI_no2 = (50/53)*(AQI - 0) + 0
  }
  
  else if (AQI <= 100 && AQI >= 54 ) {
    IAQI_no2 = (50/46)*(AQI - 54) + 51
  }
  
  else{
    IAQI_no2 = (50/259)*(AQI - 101) + 101
  }
}

# Generate IAQIs, determine AQI and AQI category based on max IAQI per day

AQI_2020 =
  AQI_2020 %>% 
  mutate(
    IAQI_o3 = map(median_o3, IAQI_formula_o3),
    IAQI_pm25 = map(median_pm25, IAQI_formula_pm25),
    IAQI_co = map(median_co, IAQI_formula_co),
    IAQI_no2 = map(median_no2, IAQI_formula_no2)
    ) %>% 
  rowwise() %>% 
  mutate(
    AQI = max(IAQI_o3, IAQI_pm25, IAQI_co, IAQI_no2, na.rm = TRUE), # Taking max of the individual AQI scores, right?
    AQI_category =
      if_else(
        AQI <= 50 & AQI >= 0,
        "Good",
        if_else(
          AQI <= 100 & AQI > 50,
          "Moderate",
          if_else(
            AQI <= 150 & AQI > 100,
            "Unhealthy for Sensitive Populations",
            "Unhealthy")
        )
      )
  )
```


```{r 2019 air quality data cleaning, include = FALSE}
# Data import and cleaning

AQI_2019 =
  tibble(
    path = list.files("./data/AQI_data_2019") # Listing all file names
    ) %>% 
  mutate(
    path = str_c("./data/AQI_data_2019/", path), # Completing the paths
    data = map(path, fread) # Reading the data for each path
    ) %>% 
  unnest(data) %>% 
  janitor::clean_names() %>% 
  filter(country == "US") %>%
  filter(city == "Brooklyn" | city == "Queens" | city == "The Bronx" | city == "Staten Island" | city == "Manhattan") %>%
  mutate(borough = city) %>%
  select(-c(city, country)) %>%
  pivot_wider(names_from = "specie", values_from = c("count", "min", "max", "median", "variance")) %>% 
  select(date, borough, median_pm25, median_o3, median_co, median_no2)

# Generate IAQIs, determine AQI and AQI category based on max IAQI per day

AQI_2019 =
  AQI_2019 %>% 
  mutate(
    IAQI_o3 = map(median_o3, IAQI_formula_o3),
    IAQI_pm25 = map(median_pm25, IAQI_formula_pm25),
    IAQI_co = map(median_co, IAQI_formula_co),
    IAQI_no2 = map(median_no2, IAQI_formula_no2)
    ) %>% 
  rowwise() %>% 
  mutate(
    AQI = max(IAQI_o3, IAQI_pm25, IAQI_co, IAQI_no2, na.rm = TRUE), # Taking max of the individual AQI scores, right?
    AQI_category =
      if_else(
        AQI <= 50 & AQI >= 0,
        "Good",
        if_else(
          AQI <= 100 & AQI > 50,
          "Moderate",
          if_else(
            AQI <= 150 & AQI > 100,
            "Unhealthy for Sensitive Populations",
            "Unhealthy")
        )
      )
  )
```

```{r merge 2019 and 2020 air quality data, include = FALSE}
AQI_2019_and_2020 =
  rbind(AQI_2019, AQI_2020) %>% 
  as_tibble() %>% 
  mutate(
    date = as.Date(date, tryFormats = c("%Y-%m-%d")),
    borough = recode(borough, "The Bronx" = "Bronx"),
    IAQI_o3 = unlist(IAQI_o3),
    IAQI_pm25 = unlist(IAQI_pm25),
    IAQI_co = unlist(IAQI_co),
    IAQI_no2 = unlist(IAQI_no2)
  )
```

```{r nyc-wide covid data cleaning, include = FALSE}
nyc_cases =
  GET("https://data.cityofnewyork.us/resource/rc75-m7u3.csv") %>% # Reading in the data
  content("parsed") %>% 
  rename(date = date_of_interest) %>% # Renaming the date variable for simplicity
  select(date, case_count) %>% # Only retaining date and case count for simplicity
  mutate(
    date = as.Date(date, tryFormats = c("%Y-%m-%d")) # as.Date() by default cannot convert POSIXct to date; no data lost
  )
```

```{r by borough covid data cleaning, cache = TRUE, include = FALSE}
nyc_daily_borough_testing =
  read_csv(
      "./data/covid_data/nyc_daily_covid.csv") %>% 
  janitor::clean_names() %>% 
  rename(date = date_of_interest) %>% 
  mutate(
    date = as.Date(date, format = "%m/%d/%Y"),
    date = as.Date(date, tryFormats = c("%Y-%m-%d"))
  ) %>%
  pivot_longer(
    bx_case_count:si_death_count_7day_avg,
    names_to = "borough_variable",
    values_to = "observed_value"
  ) %>% 
  mutate(
    borough_variable = str_replace(borough_variable, "bx_", "Bronx/"),
    borough_variable = str_replace(borough_variable, "bk_", "Brooklyn/"),
    borough_variable = str_replace(borough_variable, "qn_", "Queens/"),
    borough_variable = str_replace(borough_variable, "si_", "Staten Island/"),
    borough_variable = str_replace(borough_variable, "mn_", "Manhattan/")
  ) %>% 
  separate(borough_variable, into = c("borough", "observation_type"), sep = "/") %>% 
  arrange(date, borough, observation_type, observed_value) %>% 
  pivot_longer(
    case_count:incomplete,
    names_to = "total_observation_type",
    values_to = "total_observed_value"
  ) %>% 
  filter(observation_type == c("case_count", "case_count_7day_avg"))

# Add proof-of-concept covid policy changes to df
nyc_daily_borough_testing = 
  nyc_daily_borough_testing %>% 
  mutate(
    policy_change = case_when(
      date == "2020-03-07" ~ "State of Emergency",
      date == "2020-03-22" ~ "PAUSE Order",
      date == "2020-08-08" ~ "Phase 1 Opening",
      date == "2020-10-01" ~ "Primary Schools Open"),
    dates_vline = date,
    dates_vline = case_when(
      date == "2020-03-07" ~ "TRUE",
      date == "2020-03-22" ~ "TRUE",
      date == "2020-08-08" ~ "TRUE",
      date == "2020-10-01" ~ "TRUE")
  )
```

```{r merge air quality and covid data}
AQI_covid_master =
  left_join(nyc_daily_borough_testing, AQI_2019_and_2020, by = c("date", "borough"))
```

```{r example covid line graphs, eval = FALSE}
##make ggplot objects for plotly render
#overall
covid_aqi_overall_ggplot = 
AQI_covid_master %>% 
  filter(observation_type == c("case_count")) %>% 
  filter(total_observation_type == c("case_count")) %>% 
  group_by(date, borough) %>% 
  ggplot(aes(x = date)) + 
  geom_line(
    aes(x = date, y = total_observed_value,  group = total_observation_type),
    color = "red",
    alpha = 0.8) +
  geom_smooth(
    aes(x = date, y = total_observed_value, group = total_observation_type), 
         color = "red",
    alpha = 0.8, se = F) +
  geom_line(
    aes(x = date, y = AQI*38.64631477),
      color = "blue",
    alpha = 0.05) +
  geom_smooth(
    aes(x = date, y = AQI*38.64631477),
     color = "blue",
    alpha = 0.05) +
  scale_x_date(
    date_breaks = "1 month",
    date_labels = "%b",
    limits = as.Date(c("2020-03-01", "2020-12-01"))) +
  scale_y_continuous(
    name = "COVID Case Count",
    sec.axis = sec_axis(~./38.64631477, name = "AQI Index")) +
  coord_cartesian(ylim = c(0, NA)) +
  labs(
    title = "Case Count and AQI per NYC Borough over Time",
    x = "Week Number",
    y = "Value",
    caption = "P8105 Final Project")

# per borough
covid_aqi_borough_ggplot = 
AQI_covid_master %>% 
  filter(observation_type == c("case_count")) %>% 
  filter(total_observation_type == c("case_count")) %>% 
  group_by(date, borough) %>% 
  ggplot(aes(x = date)) + 
  geom_line(
    aes(x = date, y = observed_value, color = borough),
    alpha = 0.8) +
  geom_smooth(
    aes(x = date, y = observed_value, color = borough), 
        alpha = 0.8, se = F,
    method = "gam") +
    scale_color_manual(values = c("Bronx" = "#005EFF", "Brooklyn" = "#0086C6", "Manhattan" = "#00AF8C", "Queens" = "#00D753", "Staten Island" = "#00FF19")) +
  geom_line(
    aes(x = date, y = IAQI_co*53.40336134, color = borough),
    alpha = 0.05) +
  geom_smooth(
    aes(x = date, y = IAQI_co*53.40336134,  color = borough),
    alpha = 0.05) +
    scale_color_manual(values = c("Bronx" = "#FF0000", "Brooklyn" = "#FF3400", "Manhattan" = "#FF6800", "Queens" = "#FF9C00", "Staten Island" = "#FFD000")) +
  scale_x_date(
    date_breaks = "1 month",
    date_labels = "%b",
    limits = as.Date(c("2020-03-01", "2020-12-01"))) +
  scale_y_continuous(
    name = "COVID Case Count",
    sec.axis = sec_axis(~./53.40336134, name = "AQI Index")) +
  coord_cartesian(ylim = c(0, NA)) +
  labs(
    title = "Case Count and AQI per NYC Borough over Time",
    x = "Month",
    y = "Value",
    caption = "P8105 Final Project")


```

```{r example air quality plots, eval = FALSE}
air_quality %>% 
  ggplot(aes(x = date, y = median_co, color = borough)) + 
    geom_point(alpha = .2) +
    geom_line(alpha = .75, size = .75) +
      scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  labs(
    title = "Median CO Emmissions over Time for each NYC borough, 2020",
    x = "Month",
    y = "Median CO (Parts per Million)",
    caption = "Examining COVID-19 Incidence, P8105 Final Project") 

air_quality %>% 
  ggplot(aes(x = date, y = median_pm25, color = borough)) + 
    geom_point(alpha = .2) +
    geom_line(alpha = .75, size = .75) +
      scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  labs(
    title = "Median Particulate Matter (size<2.5 micrometers) Levels over Time for each NYC borough, 2020",
    x = "Month",
    y = "Median Particulate Matter (size < 2.5 micrometeres) Levels (Parts per Millon)",
    caption = "Examining COVID-19 Incidence, P8105 Final Project") 

air_quality %>% 
  ggplot(aes(x = date, y = median_temperature, color = borough)) + 
    geom_point(alpha = .2) +
    geom_line(alpha = .75, size = .75) +
      scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  labs(
    title = "Median Temperature over Time for each NYC borough, 2020",
    x = "Month",
    y = "Median Temperature (degrees C)",
    caption = "Examining COVID-19 Incidence, P8105 Final Project")

AQI_combined_2020 %>% 
  group_by(borough) %>% 
  ggplot(aes(x = date, y = AQI_Final)) +
  geom_line() +
  geom_smooth()
```

Column {data-width=500}
-----------------------------------------------------------------------

### COVID Cases and Air Quality Index

```{r plotly line plot 1, eval = FALSE}
#create line formatting object
line.fmt = list(dash = "solid", width = 1.5, color=NULL)

#create numeric date object for mgcv package's gam function (cannot take difftime objects)
AQI_covid_master = 
  AQI_covid_master %>% 
  mutate(
    ndate = as.numeric(date))

# create gam smoothers for plotting manually, plot_ly needs them
sp.gam.covid = gam(total_observed_value ~ s(ndate, bs = "cs"), data = AQI_covid_master, method = "GCV.Cp")
sp.pred.covid = predict(sp.gam.covid, type="response", se.fit = TRUE)
as.data.frame(sp.pred.covid)

#create lines for AQI overlay
sp.gam.aqi = gam(AQI ~ s(ndate, bs = "cs"), data = AQI_covid_master, method = "GCV.Cp")
sp.pred.aqi = predict(sp.gam.aqi, type="response", se.fit = TRUE)

#create yaxis objects
y1 <- list(
  tickfont = list(color = "red"),
  overlaying = "n",
  side = "left",
  title = "NYC COVID Case Count"
)
y2 <- list(
  tickfont = list(color = "red"),
  overlaying = "y",
  side = "right",
  title = "AQI Axis"
)

#plot_ly
pp =
AQI_covid_master %>% 
  filter(observation_type == c("case_count")) %>% 
  filter(total_observation_type == c("case_count")) %>% 
  plot_ly(x = ~date, y = ~total_observed_value, type = 'scatter', mode = "lines", name = "COVID Case Count") %>% #covid data
  add_lines(x = ~date, y = ~sp.pred.covid$fit, name = "COVID Count GAM", line = list(color = "#005EFF", width=2), opacity = 0.5) %>% #covid gam
  add_lines(x = ~date, y = ~AQI*38.64631477, name = "AQI Index", line = list(color = "#FF0000", width=2, yaxis2 = y2), opacity = 0.1) %>% #aqi data
  add_lines(x = ~date, y = ~sp.pred.aqi$fit, name = "AQI Index GAM", line = list(color = "#FF6800", width=2), yaxis2 = y2) %>% #aqi GAM
  layout(title = "Case Count and AQI per NYC Borough over Time",
           yaxis = list(y1),
           yaxis2 = list(y2),
           xaxis = list(title = 'Month'))

#gam doesn't fit well, let's try an alternative
#ll.smooth = loess(total_observed_value ~ ndate, data = AQI_covid_master, span=0.75)
#also not a good fit, let's try a cv'd model
# rllt = supsmu(AQI_covid_master$date, AQI_covid_master$total_observed_value, span = "cv") ### this runs but does not print in the plot_ly, tibble issues.
#must troubleshoot the model fit, and adding the second y-axis

```

```{r plotly line plot 2, eval = FALSE}
ggplotly(covid_aqi_borough_ggplot)

```


Column {data-width=500}
-----------------------------------------------------------------------

### Air Quality Index by Borough

```{r eval = FALSE}
borough_coord = tibble("borough" = c("The Bronx", "Manhattan", "Brooklyn", "Queens", "Staten Island"), "latitude" = c(40.8448, 40.7731, 40.6782, 40.7282, 40.5795), "longitude" = c(-73.8648, -73.9712, -73.9442, -73.7949, -74.1502))

color_df = colorFactor(c("green", "yellow", "orange", "red"), domain = c("Good", "Moderate", "Unhealthy for Sensitive Populations", "Unhealthy"))

AQI_combined_2020 = AQI_combined_2020 %>% 
  left_join(borough_coord, by = "borough")


renderLeaflet({
  AQI_combined_2020 %>% 
    filter(date == input[["date"]]) %>% 
    mutate(popup = str_c("<strong>", borough, "</strong>", "<br/>", "Date: ", date, "<br/>", "Air Quality Category: ", AQI_Category, "<br/>", "Air Quality Index: ", round(AQI_Final, 2), "<br/>", "Carbon Monoxide Level: ", round(AQI_co, 2)) %>% 
    map(htmltools::HTML)) %>%
    leaflet() %>%
    addTiles() %>%
    setView(-73.95, 40.7228, zoom = 11) %>%
    addProviderTiles("CartoDB.Positron") %>% 
    addCircleMarkers(
      radius = 20,
      lng = ~longitude,
      lat = ~latitude,
      stroke = FALSE,
      fillOpacity = 0.8, 
      color = ~color_df(AQI_Category),
      label = ~popup
    ) %>% 
    addLegend("bottomright", colors = c("green", "yellow", "orange", "red"),
              labels = c("Good", "Moderate", "Unhealthy for Sensitive Populations", "Unhealthy"),
              title = "Air Quality Index")
})





```

Column {data-width=200}
-----------------------------------------------------------------------

Here we can write some introductory text/explain our project.

```{r input}
 dateInput(
    "date",
    label = h3("Date input"),
    value = "2020-02-29", # Default value
    min = "2020-02-29", # Min value
    max = "2020-11-17") # Max value

# I put in these dates based on the covid dataset, but we can update as needed
```
